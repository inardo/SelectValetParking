<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valet Parking Management</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        }
        .header-container {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            padding: 1.5rem;
            margin: -1rem -1rem 1.5rem -1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
        }
        .brand-logo {
            max-height: 60px;
            width: auto;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }
        .header-title {
            color: white;
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        @media (max-width: 768px) {
            .header-title {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // Icons
        const Search = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.35-4.35"></path>
            </svg>
        );

        const X = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        );

        const Plus = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const AlertCircle = ({ size = 24, className = "" }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
        );

        const ValetParkingApp = () => {
            const [lotD, setLotD] = useState(() => {
                const saved = localStorage.getItem('lotD');
                if (!saved) return {};
                try {
                    const parsed = JSON.parse(saved);
                    const migrated = {};
                    for (const [stall, value] of Object.entries(parsed)) {
                        if (typeof value === 'string') {
                            migrated[stall] = value;
                        } else if (value && typeof value === 'object' && value.front) {
                            migrated[stall] = value.front;
                        }
                    }
                    return migrated;
                } catch {
                    return {};
                }
            });
            
            const [lotX, setLotX] = useState(() => {
                const saved = localStorage.getItem('lotX');
                return saved ? JSON.parse(saved) : {};
            });
            
            const [lotY, setLotY] = useState(() => {
                const saved = localStorage.getItem('lotY');
                return saved ? JSON.parse(saved) : {};
            });
            
            const [overflowX, setOverflowX] = useState(() => {
                const saved = localStorage.getItem('overflowX');
                return saved ? JSON.parse(saved) : {};
            });
            
            const [overflowY, setOverflowY] = useState(() => {
                const saved = localStorage.getItem('overflowY');
                return saved ? JSON.parse(saved) : {};
            });
            
            useEffect(() => { localStorage.setItem('lotD', JSON.stringify(lotD)); }, [lotD]);
            useEffect(() => { localStorage.setItem('lotX', JSON.stringify(lotX)); }, [lotX]);
            useEffect(() => { localStorage.setItem('lotY', JSON.stringify(lotY)); }, [lotY]);
            useEffect(() => { localStorage.setItem('overflowX', JSON.stringify(overflowX)); }, [overflowX]);
            useEffect(() => { localStorage.setItem('overflowY', JSON.stringify(overflowY)); }, [overflowY]);
            
            const [activeTab, setActiveTab] = useState('X');
            const [searchTerm, setSearchTerm] = useState('');
            const [editingStall, setEditingStall] = useState(null);
            const [editingOverflow, setEditingOverflow] = useState(null);
            const [searchResult, setSearchResult] = useState(null);
            const [showClearAllConfirm, setShowClearAllConfirm] = useState(null);
            const [draggedItem, setDraggedItem] = useState(null);

            const lotXOverflowSpots = ['OF1', 'OF2', 'OF3', 'OF4', 'OF5', 'OF6', 'OF7', 'OF8', 'OF9'];
            const lotYOverflowSpots = ['OF1', 'OF2', 'OF3', 'OF4', 'OF5', 'OF6', 'OF7', 'OF8', 'OF9', 'OF10'];
            const lotDStalls = useMemo(() => {
                const stalls = [];
                for (let i = 1; i <= 12; i++) stalls.push(`D${i}`);
                for (let i = 1; i <= 12; i++) stalls.push(`D${i}D`);
                for (let i = 1; i <= 12; i++) stalls.push(`D${i}T`);
                stalls.push('D', 'DD', 'DT');
                return stalls;
            }, []);
            const lotXStalls = ['X1', 'X2', 'X3', 'X4', 'X5', 'X6'];
            const lotYStalls = ['YE', 'Y1', 'Y2', 'Y3', 'Y4', 'Y5', 'Y6', 'Y7', 'Y8', 'Y9', 'Y10', 'Y11'];

            const getBlockingInfo = (lot, stallId) => {
                if (lot === 'D') {
                    // Extract the base number from stall ID
                    if (stallId === 'D' || stallId === 'DD' || stallId === 'DT') return null;
                    
                    // Determine which row this stall is in
                    let baseNumber;
                    let currentRow; // 1 = back (D1-D12), 2 = middle (D1D-D12D), 3 = front (D1T-D12T)
                    
                    if (stallId.endsWith('T')) {
                        // Front row (D1T-D12T) - never blocked
                        return null;
                    } else if (stallId.endsWith('D')) {
                        // Middle row (D1D-D12D) - blocked by front row
                        baseNumber = stallId.replace('D', '').replace('D', ''); // Remove both D's to get number
                        currentRow = 2;
                        const frontStall = `D${baseNumber}T`;
                        const frontTicket = lotD[frontStall];
                        if (frontTicket) {
                            return { stall: frontStall, ticket: frontTicket };
                        }
                        return null;
                    } else {
                        // Back row (D1-D12) - blocked by middle and/or front row
                        baseNumber = stallId.replace('D', ''); // Remove D to get number
                        currentRow = 1;
                        const middleStall = `D${baseNumber}D`;
                        const frontStall = `D${baseNumber}T`;
                        const middleTicket = lotD[middleStall];
                        const frontTicket = lotD[frontStall];
                        
                        if (middleTicket || frontTicket) {
                            const blockingStalls = [];
                            if (middleTicket) blockingStalls.push({ stall: middleStall, ticket: middleTicket });
                            if (frontTicket) blockingStalls.push({ stall: frontStall, ticket: frontTicket });
                            return { multiple: true, blocking: blockingStalls };
                        }
                        return null;
                    }
                }
                
                const overflowData = lot === 'X' ? overflowX : lot === 'Y' ? overflowY : null;
                if (!overflowData) return null;
                for (const [ofId, data] of Object.entries(overflowData)) {
                    if (data.blocks && data.blocks.includes(stallId)) {
                        return { ofId, ticket: data.ticket };
                    }
                }
                return null;
            };

            const checkDuplicateTicket = (ticketNum, currentLot, currentStall, isOverflow = false) => {
                if (!ticketNum) return null;
                for (const [stallId, ticketVal] of Object.entries(lotD)) {
                    if (ticketVal === ticketNum && !(currentLot === 'D' && currentStall === stallId && !isOverflow)) {
                        return { lot: 'D', stall: stallId };
                    }
                }
                for (const [stallId, ticketVal] of Object.entries(lotX)) {
                    if (ticketVal === ticketNum && !(currentLot === 'X' && currentStall === stallId && !isOverflow)) {
                        return { lot: 'X', stall: stallId };
                    }
                }
                for (const [stallId, ticketVal] of Object.entries(lotY)) {
                    if (ticketVal === ticketNum && !(currentLot === 'Y' && currentStall === stallId && !isOverflow)) {
                        return { lot: 'Y', stall: stallId };
                    }
                }
                for (const [ofId, data] of Object.entries(overflowX)) {
                    if (data.ticket === ticketNum && !(currentLot === 'X' && currentStall === ofId && isOverflow)) {
                        return { lot: 'X', overflow: ofId };
                    }
                }
                for (const [ofId, data] of Object.entries(overflowY)) {
                    if (data.ticket === ticketNum && !(currentLot === 'Y' && currentStall === ofId && isOverflow)) {
                        return { lot: 'Y', overflow: ofId };
                    }
                }
                return null;
            };

            const handleSearch = () => {
                if (!searchTerm) {
                    setSearchResult(null);
                    return;
                }
                const ticket = searchTerm.trim();
                if (ticket.length !== 6) {
                    setSearchResult({ error: 'Please enter a 6-digit ticket number' });
                    return;
                }
                if (!/^\d+$/.test(ticket)) {
                    setSearchResult({ error: 'Ticket number must contain only numbers' });
                    return;
                }
                for (const [stall, ticketNum] of Object.entries(lotD)) {
                    if (ticketNum === ticket) {
                        const blockingInfo = getBlockingInfo('D', stall);
                        setSearchResult({ lot: 'D', stall, blockingInfo });
                        setActiveTab('D');
                        return;
                    }
                }
                for (const [stall, ticketNum] of Object.entries(lotX)) {
                    if (ticketNum === ticket) {
                        const blockingInfo = getBlockingInfo('X', stall);
                        setSearchResult({ lot: 'X', stall, blockingInfo });
                        setActiveTab('X');
                        return;
                    }
                }
                for (const [stall, ticketNum] of Object.entries(lotY)) {
                    if (ticketNum === ticket) {
                        const blockingInfo = getBlockingInfo('Y', stall);
                        setSearchResult({ lot: 'Y', stall, blockingInfo });
                        setActiveTab('Y');
                        return;
                    }
                }
                for (const [ofId, data] of Object.entries(overflowX)) {
                    if (data.ticket === ticket) {
                        setSearchResult({ lot: 'X', overflow: ofId, blocks: data.blocks });
                        setActiveTab('X');
                        return;
                    }
                }
                for (const [ofId, data] of Object.entries(overflowY)) {
                    if (data.ticket === ticket) {
                        setSearchResult({ lot: 'Y', overflow: ofId, blocks: data.blocks });
                        setActiveTab('Y');
                        return;
                    }
                }
                setSearchResult({ notFound: true });
            };

            const handleClearAll = (lot) => {
                if (lot === 'X') {
                    setLotX({});
                    setOverflowX({});
                } else if (lot === 'Y') {
                    setLotY({});
                    setOverflowY({});
                } else if (lot === 'D') {
                    setLotD({});
                }
                setShowClearAllConfirm(null);
            };

            const ClearAllConfirmation = ({ lot, onConfirm, onCancel }) => {
                const getCount = () => {
                    if (lot === 'X') {
                        return Object.keys(lotX).length + Object.keys(overflowX).length;
                    } else if (lot === 'Y') {
                        return Object.keys(lotY).length + Object.keys(overflowY).length;
                    } else {
                        return Object.keys(lotD).length;
                    }
                };

                const count = getCount();

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-lg p-6 max-w-md w-full">
                            <div className="flex items-start gap-3 mb-4">
                                <AlertCircle className="text-red-600 flex-shrink-0" size={24} />
                                <div>
                                    <h3 className="text-xl font-bold text-red-600">Clear All Data?</h3>
                                    <p className="text-gray-700 mt-2">
                                        Are you sure you want to clear ALL data from Lot {lot}?
                                    </p>
                                    <p className="text-gray-700 mt-2 font-semibold">
                                        This will remove {count} vehicle{count !== 1 ? 's' : ''} and cannot be undone.
                                    </p>
                                </div>
                            </div>
                            
                            <div className="flex gap-2 mt-6">
                                <button
                                    onClick={onConfirm}
                                    className="flex-1 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 font-semibold"
                                >
                                    Yes, Clear All
                                </button>
                                <button
                                    onClick={onCancel}
                                    className="flex-1 bg-gray-300 px-4 py-2 rounded hover:bg-gray-400"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const StallEditor = ({ stall, lot, onClose }) => {
                const currentData = lot === 'D' ? { ticket: lotD[stall] } :
                                    lot === 'X' ? { ticket: lotX[stall] } : 
                                    { ticket: lotY[stall] };
                const [ticket, setTicket] = useState(currentData.ticket || '');
                const [error, setError] = useState('');
                const blockingInfo = getBlockingInfo(lot, stall);

                const handleTicketChange = (value) => {
                    const numericValue = value.replace(/[^0-9]/g, '');
                    setTicket(numericValue);
                    setError('');
                };

                const handleSave = () => {
                    if (ticket && ticket.length !== 6) {
                        setError('Ticket number must be exactly 6 digits');
                        return;
                    }
                    const duplicate = checkDuplicateTicket(ticket, lot, stall, false);
                    if (duplicate) {
                        if (duplicate.overflow) {
                            setError(`Ticket already exists in Lot ${duplicate.lot} - ${duplicate.overflow}`);
                        } else {
                            setError(`Ticket already exists in Lot ${duplicate.lot} - Stall ${duplicate.stall}`);
                        }
                        return;
                    }
                    if (lot === 'D') {
                        if (!ticket) {
                            const newLotD = { ...lotD };
                            delete newLotD[stall];
                            setLotD(newLotD);
                        } else {
                            setLotD({ ...lotD, [stall]: ticket });
                        }
                    } else if (lot === 'X') {
                        if (!ticket) {
                            const newLotX = { ...lotX };
                            delete newLotX[stall];
                            setLotX(newLotX);
                        } else {
                            setLotX({ ...lotX, [stall]: ticket });
                        }
                    } else {
                        if (!ticket) {
                            const newLotY = { ...lotY };
                            delete newLotY[stall];
                            setLotY(newLotY);
                        } else {
                            setLotY({ ...lotY, [stall]: ticket });
                        }
                    }
                    onClose();
                };

                const handleClear = () => {
                    if (lot === 'D') {
                        const newLotD = { ...lotD };
                        delete newLotD[stall];
                        setLotD(newLotD);
                    } else if (lot === 'X') {
                        const newLotX = { ...lotX };
                        delete newLotX[stall];
                        setLotX(newLotX);
                    } else {
                        const newLotY = { ...lotY };
                        delete newLotY[stall];
                        setLotY(newLotY);
                    }
                    onClose();
                };

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-lg p-6 max-w-md w-full">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-xl font-bold">Edit {stall}</h3>
                                <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
                                    <X size={24} />
                                </button>
                            </div>
                            {blockingInfo && (
                                <div className="mb-4 p-3 bg-orange-50 border border-orange-200 rounded flex items-start gap-2">
                                    <AlertCircle className="text-orange-600 flex-shrink-0 mt-0.5" size={20} />
                                    <div className="text-sm">
                                        {lot === 'D' && blockingInfo.multiple ? (
                                            <div>
                                                <p className="font-semibold text-orange-800">Blocked by:</p>
                                                {blockingInfo.blocking.map((b, i) => (
                                                    <p key={i} className="text-orange-700">{b.stall}: {b.ticket}</p>
                                                ))}
                                            </div>
                                        ) : lot === 'D' ? (
                                            <div>
                                                <p className="font-semibold text-orange-800">Blocked by {blockingInfo.stall}</p>
                                                <p className="text-orange-700">Ticket: {blockingInfo.ticket}</p>
                                            </div>
                                        ) : (
                                            <div>
                                                <p className="font-semibold text-orange-800">Blocked by {blockingInfo.ofId}</p>
                                                <p className="text-orange-700">Ticket: {blockingInfo.ticket}</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                            <div>
                                <label className="block text-sm font-medium mb-1">Ticket Number</label>
                                <input
                                    type="text"
                                    value={ticket}
                                    onChange={(e) => handleTicketChange(e.target.value)}
                                    placeholder="6-digit ticket"
                                    maxLength="6"
                                    inputMode="numeric"
                                    className={`w-full px-3 py-2 border rounded ${error ? 'border-red-500' : ''}`}
                                    disabled={lot !== 'D' && !!blockingInfo}
                                />
                                {error && (
                                    <p className="text-xs text-red-600 mt-1 flex items-center gap-1">
                                        <AlertCircle size={12} />
                                        {error}
                                    </p>
                                )}
                                {!error && blockingInfo && lot === 'D' && (
                                    <p className="text-xs text-orange-600 mt-1">
                                        Warning: This car is blocked by car(s) behind it.
                                    </p>
                                )}
                                {!error && blockingInfo && lot !== 'D' && (
                                    <p className="text-xs text-red-600 mt-1">
                                        Cannot edit - car is blocked by overflow.
                                    </p>
                                )}
                                {!error && ticket && ticket.length < 6 && (
                                    <p className="text-xs text-gray-500 mt-1">
                                        {6 - ticket.length} more digit{6 - ticket.length !== 1 ? 's' : ''} needed
                                    </p>
                                )}
                            </div>
                            <div className="flex gap-2 mt-6">
                                <button
                                    onClick={handleSave}
                                    disabled={lot !== 'D' && !!blockingInfo}
                                    className="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 disabled:bg-gray-400"
                                >
                                    Save
                                </button>
                                {currentData.ticket && (
                                    <button
                                        onClick={handleClear}
                                        className="flex-1 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700"
                                    >
                                        Clear
                                    </button>
                                )}
                                <button
                                    onClick={onClose}
                                    className="flex-1 bg-gray-300 px-4 py-2 rounded hover:bg-gray-400"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const OverflowEditor = ({ lot, ofId, onClose }) => {
                const overflowData = lot === 'X' ? overflowX : overflowY;
                const isNew = !overflowData[ofId];
                const [ticket, setTicket] = useState(overflowData[ofId]?.ticket || '');
                const [selectedStalls, setSelectedStalls] = useState(overflowData[ofId]?.blocks || []);
                const [error, setError] = useState('');
                const availableStalls = lot === 'X' ? lotXStalls : lotYStalls;

                const handleTicketChange = (value) => {
                    const numericValue = value.replace(/[^0-9]/g, '');
                    setTicket(numericValue);
                    setError('');
                };

                const toggleStall = (stall) => {
                    setSelectedStalls(prev => 
                        prev.includes(stall) ? prev.filter(s => s !== stall) : [...prev, stall]
                    );
                };

                const handleSave = () => {
                    if (!ticket) {
                        setError('Ticket number is required');
                        return;
                    }
                    if (ticket.length !== 6) {
                        setError('Ticket number must be exactly 6 digits');
                        return;
                    }
                    const duplicate = checkDuplicateTicket(ticket, lot, ofId, true);
                    if (duplicate) {
                        if (duplicate.overflow) {
                            setError(`Ticket already exists in Lot ${duplicate.lot} - ${duplicate.overflow}`);
                        } else {
                            setError(`Ticket already exists in Lot ${duplicate.lot} - Stall ${duplicate.stall}`);
                        }
                        return;
                    }
                    const newData = { ticket, blocks: selectedStalls };
                    if (lot === 'X') {
                        setOverflowX({ ...overflowX, [ofId]: newData });
                    } else {
                        setOverflowY({ ...overflowY, [ofId]: newData });
                    }
                    onClose();
                };

                const handleDelete = () => {
                    if (lot === 'X') {
                        const newOverflowX = { ...overflowX };
                        delete newOverflowX[ofId];
                        setOverflowX(newOverflowX);
                    } else {
                        const newOverflowY = { ...overflowY };
                        delete newOverflowY[ofId];
                        setOverflowY(newOverflowY);
                    }
                    onClose();
                };

                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-lg p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-xl font-bold">{isNew ? 'Add' : 'Edit'} {ofId}</h3>
                                <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
                                    <X size={24} />
                                </button>
                            </div>
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-sm font-medium mb-1">Ticket Number</label>
                                    <input
                                        type="text"
                                        value={ticket}
                                        onChange={(e) => handleTicketChange(e.target.value)}
                                        placeholder="6-digit ticket"
                                        maxLength="6"
                                        inputMode="numeric"
                                        className={`w-full px-3 py-2 border rounded ${error ? 'border-red-500' : ''}`}
                                    />
                                    {error && (
                                        <p className="text-xs text-red-600 mt-1 flex items-center gap-1">
                                            <AlertCircle size={12} />
                                            {error}
                                        </p>
                                    )}
                                    {!error && ticket && ticket.length < 6 && (
                                        <p className="text-xs text-gray-500 mt-1">
                                            {6 - ticket.length} more digit{6 - ticket.length !== 1 ? 's' : ''} needed
                                        </p>
                                    )}
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-2">Blocks Stalls (optional):</label>
                                    <div className="grid grid-cols-4 gap-2 max-h-48 overflow-y-auto p-2 border rounded">
                                        {availableStalls.map(stall => {
                                            const stallData = lot === 'X' ? lotX[stall] : lotY[stall];
                                            return (
                                                <button
                                                    key={stall}
                                                    onClick={() => toggleStall(stall)}
                                                    className={`px-2 py-2 rounded border text-xs ${
                                                        selectedStalls.includes(stall)
                                                            ? 'bg-red-500 text-white border-red-600'
                                                            : 'bg-white border-gray-300 hover:bg-gray-50'
                                                    }`}
                                                >
                                                    <div className="font-bold">{stall}</div>
                                                    {stallData && (
                                                        <div className="text-[10px] mt-0.5 truncate">
                                                            {stallData}
                                                        </div>
                                                    )}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                            <div className="flex gap-2 mt-6">
                                <button
                                    onClick={handleSave}
                                    className="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                                >
                                    Save
                                </button>
                                {!isNew && (
                                    <button
                                        onClick={handleDelete}
                                        className="flex-1 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700"
                                    >
                                        Delete
                                    </button>
                                )}
                                <button
                                    onClick={onClose}
                                    className="flex-1 bg-gray-300 px-4 py-2 rounded hover:bg-gray-400"
                                >
                                    Cancel
                                </button>
                            </div>
                        </div>
                    </div>
                );
            };

            const Stall = ({ id, lot, data, vertical = true, size = 'normal' }) => {
                const isOccupied = !!data;
                const blockingInfo = getBlockingInfo(lot, id);
                const isHighlighted = searchResult && searchResult.lot === lot && searchResult.stall === id && !searchResult.overflow;
                const sizeClasses = size === 'large' ? 'min-h-32' : size === 'medium' ? 'min-h-24' : 'min-h-20';

                // Priority: Blocked > Highlighted > Occupied > Empty
                let bgColor, borderColor, ringColor;
                
                if (blockingInfo) {
                    // Always show blocked stalls in red, regardless of other states
                    bgColor = 'bg-red-100';
                    borderColor = 'border-red-400';
                    ringColor = '';
                } else if (isHighlighted) {
                    bgColor = 'bg-yellow-100';
                    borderColor = 'border-yellow-400';
                    ringColor = 'ring-4 ring-yellow-300';
                } else if (isOccupied) {
                    bgColor = 'bg-green-100';
                    borderColor = 'border-green-600';
                    ringColor = '';
                } else {
                    bgColor = 'bg-white';
                    borderColor = 'border-gray-400';
                    ringColor = 'hover:bg-gray-50';
                }

                return (
                    <button
                        onClick={() => setEditingStall({ stall: id, lot })}
                        className={`${sizeClasses} p-2 rounded text-xs font-medium border-2 transition-all ${vertical ? 'w-full' : ''} ${bgColor} ${borderColor} ${ringColor}`}
                    >
                        <div className="font-bold text-sm">{id}</div>
                        {data && <div className="text-[10px] mt-1 truncate">{data}</div>}
                        {blockingInfo && lot === 'D' && (
                            <div className="text-[9px] text-red-700 mt-1 font-semibold">
                                {blockingInfo.multiple ? (
                                    <div>Blocked by: {blockingInfo.blocking.map(b => `${b.stall}`).join(', ')}</div>
                                ) : (
                                    <div>Blocked by {blockingInfo.stall}</div>
                                )}
                            </div>
                        )}
                        {blockingInfo && lot !== 'D' && (
                            <div className="text-[9px] text-red-700 mt-1 font-semibold">
                                Blocked by {blockingInfo.ofId}
                            </div>
                        )}
                    </button>
                );
            };

            const OverflowSpot = ({ id, lot }) => {
                const overflowData = lot === 'X' ? overflowX : overflowY;
                const data = overflowData[id];
                const isOccupied = !!data;
                const isHighlighted = searchResult && searchResult.overflow === id && searchResult.lot === lot;

                return (
                    <button
                        onClick={() => setEditingOverflow({ lot, ofId: id })}
                        className={`min-h-16 p-2 rounded text-xs font-medium border-2 transition-all ${
                            isHighlighted ? 'border-yellow-400 bg-yellow-100 ring-4 ring-yellow-300' :
                            isOccupied ? 'bg-orange-100 border-orange-500' : 
                            'bg-gray-50 border-gray-400 hover:bg-gray-100'
                        }`}
                    >
                        <div className="font-bold">{id}</div>
                        {data && (
                            <div className="mt-1">
                                <div className="text-[10px] truncate">{data.ticket}</div>
                                {data.blocks && data.blocks.length > 0 && (
                                    <div className="text-[9px] text-orange-700 mt-1">
                                        Blocks: {data.blocks.join(', ')}
                                    </div>
                                )}
                            </div>
                        )}
                        {!data && <div className="text-[9px] text-gray-500 mt-1">Empty</div>}
                    </button>
                );
            };

            return (
                <div className="min-h-screen bg-gray-100 p-4">
                    <div className="max-w-7xl mx-auto">
                        <div className="header-container">
                            <div className="logo-container">
                                {/* Replace YOUR_LOGO_URL_HERE with your actual logo URL */}
                                <img src="\select-valet.png" alt="Company Logo" className="brand-logo" />
                                <h1 className="header-title">Valet Parking Management</h1>
                            </div>
                        </div>
                        
                        <div className="bg-white rounded-lg shadow p-4 mb-4">
                            <div className="flex gap-2">
                                <input
                                    type="text"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
                                    placeholder="Enter 6-digit ticket number"
                                    maxLength="6"
                                    inputMode="numeric"
                                    className="flex-1 px-4 py-2 border rounded"
                                />
                                <button
                                    onClick={handleSearch}
                                    className="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 flex items-center gap-2"
                                >
                                    <Search size={20} />
                                    Search
                                </button>
                                {searchResult && (
                                    <button
                                        onClick={() => { setSearchResult(null); setSearchTerm(''); }}
                                        className="bg-gray-300 px-4 py-2 rounded hover:bg-gray-400"
                                    >
                                        Clear
                                    </button>
                                )}
                            </div>
                            
                            {searchResult && (
                                <div className="mt-3 p-3 rounded bg-blue-50 border border-blue-200">
                                    {searchResult.error ? (
                                        <p className="text-red-600 font-medium flex items-center gap-1">
                                            <AlertCircle size={16} />
                                            {searchResult.error}
                                        </p>
                                    ) : searchResult.notFound ? (
                                        <p className="text-red-600 font-medium">Ticket not found</p>
                                    ) : searchResult.overflow ? (
                                        <p className="font-medium">
                                            Found in Lot {searchResult.lot} - {searchResult.overflow}
                                            {searchResult.blocks && searchResult.blocks.length > 0 && 
                                                ` (blocks: ${searchResult.blocks.join(', ')})`
                                            }
                                        </p>
                                    ) : (
                                        <div>
                                            <p className="font-medium">
                                                Found in Lot {searchResult.lot} - Stall {searchResult.stall}
                                            </p>
                                            {searchResult.blockingInfo && (
                                                <div className="mt-2 p-2 bg-orange-100 border border-orange-300 rounded">
                                                    <p className="font-semibold text-orange-800 flex items-center gap-1">
                                                        <AlertCircle size={16} />
                                                        Warning: This car is blocked!
                                                    </p>
                                                    {searchResult.blockingInfo.multiple ? (
                                                        <div className="text-sm text-orange-700 mt-1">
                                                            <p>Blocked by:</p>
                                                            {searchResult.blockingInfo.blocking.map((b, i) => (
                                                                <p key={i}>• {b.stall}: {b.ticket}</p>
                                                            ))}
                                                        </div>
                                                    ) : searchResult.blockingInfo.ofId ? (
                                                        <p className="text-sm text-orange-700 mt-1">
                                                            Blocked by {searchResult.blockingInfo.ofId}: {searchResult.blockingInfo.ticket}
                                                        </p>
                                                    ) : (
                                                        <p className="text-sm text-orange-700 mt-1">
                                                            Blocked by {searchResult.blockingInfo.stall}: {searchResult.blockingInfo.ticket}
                                                        </p>
                                                    )}
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        <div className="flex gap-2 mb-4">
                            {['X', 'Y', 'D'].map(tab => (
                                <button
                                    key={tab}
                                    onClick={() => setActiveTab(tab)}
                                    className={`flex-1 py-3 px-6 rounded-lg font-semibold transition-all ${
                                        activeTab === tab 
                                            ? 'bg-blue-600 text-white shadow-lg' 
                                            : 'bg-white text-gray-700 hover:bg-gray-100'
                                    }`}
                                >
                                    Lot {tab}
                                </button>
                            ))}
                        </div>

                        {activeTab === 'X' && (
                            <div className="bg-white rounded-lg shadow p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold">Lot X</h2>
                                    <button
                                        onClick={() => setShowClearAllConfirm('X')}
                                        className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 font-semibold text-sm"
                                    >
                                        Clear All
                                    </button>
                                </div>
                                <div className="grid grid-cols-6 gap-3 mb-4">
                                    {['X1', 'X2', 'X3', 'X4'].map(stall => (
                                        <Stall key={stall} id={stall} lot="X" data={lotX[stall]} size="large" />
                                    ))}
                                    <OverflowSpot id="OF5" lot="X" />
                                    <div className="flex items-center justify-center text-sm text-gray-600 font-semibold">RAMP →</div>
                                </div>
                                <div className="grid grid-cols-6 gap-3 mb-4">
                                    {['OF1', 'OF2', 'OF3', 'OF4'].map(of => (
                                        <OverflowSpot key={of} id={of} lot="X" />
                                    ))}
                                    <div></div>
                                    <div></div>
                                </div>
                                <div className="grid grid-cols-6 gap-3">
                                    {['OF6', 'OF7', 'OF8', 'OF9'].map(of => (
                                        <OverflowSpot key={of} id={of} lot="X" />
                                    ))}
                                    <div></div>
                                    <div></div>
                                </div>
                                <div className="grid grid-cols-6 gap-3 mt-4">
                                    <div></div>
                                    <Stall id="X5" lot="X" data={lotX['X5']} size="large" />
                                    <Stall id="X6" lot="X" data={lotX['X6']} size="large" />
                                    <div></div>
                                    <div></div>
                                    <div></div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'Y' && (
                            <div className="bg-white rounded-lg shadow p-6">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold">Lot Y</h2>
                                    <button
                                        onClick={() => setShowClearAllConfirm('Y')}
                                        className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 font-semibold text-sm"
                                    >
                                        Clear All
                                    </button>
                                </div>
                                <div className="grid grid-cols-6 gap-3 mb-4">
                                    <Stall id="YE" lot="Y" data={lotY['YE']} size="large" />
                                    {['Y1', 'Y2', 'Y3', 'Y4', 'Y5'].map(stall => (
                                        <Stall key={stall} id={stall} lot="Y" data={lotY[stall]} size="large" />
                                    ))}
                                </div>
                                <div className="grid grid-cols-6 gap-3 mb-4">
                                    <div></div>
                                    {['OF1', 'OF2', 'OF3', 'OF4'].map(of => (
                                        <OverflowSpot key={of} id={of} lot="Y" />
                                    ))}
                                    <div></div>
                                </div>
                                <div className="grid grid-cols-7 gap-3 mb-4">
                                    {['OF5', 'OF6', 'OF7', 'OF8'].map(of => (
                                        <OverflowSpot key={of} id={of} lot="Y" />
                                    ))}
                                    <OverflowSpot id="OF9" lot="Y" />
                                    <OverflowSpot id="OF10" lot="Y" />
                                    <div className="flex items-center justify-center text-sm text-gray-600 font-semibold">RAMP →</div>
                                </div>
                                <div className="grid grid-cols-6 gap-3">
                                    {['Y6', 'Y7', 'Y8', 'Y9', 'Y10', 'Y11'].map(stall => (
                                        <Stall key={stall} id={stall} lot="Y" data={lotY[stall]} size="large" />
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'D' && (
                            <div className="bg-white rounded-lg shadow p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-2xl font-bold">Lot D (36 Stalls)</h2>
                                    <button
                                        onClick={() => setShowClearAllConfirm('D')}
                                        className="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700 font-semibold text-sm"
                                    >
                                        Clear All
                                    </button>
                                </div>
                                <p className="text-sm text-gray-600 mb-4">
                                    Front row (D1T-D12T) leaves first, then middle (D1D-D12D), then back (D1-D12).
                                </p>
                                <div className="mb-6">
                                    <h3 className="font-semibold mb-3 text-gray-700">Back Row (D1-D12) - Leaves Last</h3>
                                    <div className="grid gap-3" style={{gridTemplateColumns: 'auto repeat(12, 1fr)'}}>
                                        <Stall id="D" lot="D" data={lotD['D']} size="medium" />
                                        {lotDStalls.slice(0, 12).map(stall => (
                                            <Stall key={stall} id={stall} lot="D" data={lotD[stall]} />
                                        ))}
                                    </div>
                                </div>
                                <div className="mb-6">
                                    <h3 className="font-semibold mb-3 text-gray-700">Middle Row (D1D-D12D) - Leaves Second</h3>
                                    <div className="grid gap-3" style={{gridTemplateColumns: 'auto repeat(12, 1fr)'}}>
                                        <Stall id="DD" lot="D" data={lotD['DD']} size="medium" />
                                        {lotDStalls.slice(12, 24).map(stall => (
                                            <Stall key={stall} id={stall} lot="D" data={lotD[stall]} />
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    <h3 className="font-semibold mb-3 text-gray-700">Front Row (D1T-D12T) - Leaves First</h3>
                                    <div className="grid gap-3" style={{gridTemplateColumns: 'auto repeat(12, 1fr)'}}>
                                        <Stall id="DT" lot="D" data={lotD['DT']} size="medium" />
                                        {lotDStalls.slice(24, 36).map(stall => (
                                            <Stall key={stall} id={stall} lot="D" data={lotD[stall]} />
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="bg-white rounded-lg shadow p-4 mt-6">
                            <h3 className="font-semibold mb-3">Legend:</h3>
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-3 text-sm">
                                <div className="flex items-center gap-2">
                                    <div className="w-8 h-8 bg-white border-2 border-gray-400 rounded"></div>
                                    <span>Empty Stall</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-8 h-8 bg-green-100 border-2 border-green-600 rounded"></div>
                                    <span>Occupied Stall</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-8 h-8 bg-red-100 border-2 border-red-400 rounded"></div>
                                    <span>Blocked Stall</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-8 h-8 bg-gray-50 border-2 border-gray-400 rounded"></div>
                                    <span>Empty Overflow</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-8 h-8 bg-orange-100 border-2 border-orange-500 rounded"></div>
                                    <span>Occupied Overflow</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-8 h-8 bg-yellow-100 border-2 border-yellow-400 rounded"></div>
                                    <span>Search Result</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {editingStall && (
                        <StallEditor
                            stall={editingStall.stall}
                            lot={editingStall.lot}
                            onClose={() => setEditingStall(null)}
                        />
                    )}

                    {editingOverflow && (
                        <OverflowEditor
                            lot={editingOverflow.lot}
                            ofId={editingOverflow.ofId}
                            onClose={() => setEditingOverflow(null)}
                        />
                    )}

                    {showClearAllConfirm && (
                        <ClearAllConfirmation
                            lot={showClearAllConfirm}
                            onConfirm={() => handleClearAll(showClearAllConfirm)}
                            onCancel={() => setShowClearAllConfirm(null)}
                        />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ValetParkingApp />);
    </script>
</body>
</html>
